name: Windows App Build and Test

# mainブランチにpushされた時、またはPull Requestが作られた時に自動実行
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    # ここがポイント！ Windows 10(2019) と Windows 11(2022) の両方で同時にテストを走らせます
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-2019, windows-2022]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11' # お使いのPythonバージョンに合わせて変更してください

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install flet pyinstaller
        # もし requirements.txt がある場合は以下のコメントアウトを外してください
        # pip install -r requirements.txt

    - name: Build Executable
      run: python build.py

    - name: Run and Test Executable
      shell: powershell
      run: |
        $exePath = ".\dist\Issuer.exe"
        Write-Host "Starting $exePath..."

        # Start the exe and get process info
        $process = Start-Process -FilePath $exePath -PassThru -NoNewWindow

        Write-Host "Waiting for 5 seconds to check for crashes..."
        Start-Sleep -Seconds 5

        # Check if the process has already exited
        if ($process.HasExited) {
            if ($process.ExitCode -ne 0) {
                Write-Error "FAIL: App crashed immediately after launch! (Exit Code: $($process.ExitCode))"
                exit 1
            } else {
                Write-Error "FAIL: No error reported, but the app closed immediately."
                exit 1
            }
        } else {
            Write-Host "PASS: App launched successfully and is still running."
            # Test complete, force stop the app process
            Stop-Process -Id $process.Id -Force
        }