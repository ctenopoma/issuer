name: Windows App Build and Test (Tauri/Rust)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    name: Build and Test on Windows
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-2019, windows-2022]

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Rust
        uses: actions/setup-rust@v1
        with:
          rust-version: stable

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: (Optional) Build frontend
        run: |
          if [ -f package.json ]; then
            npm ci
            npm run build --if-present
          fi

      - name: Build src-tauri (release)
        working-directory: src-tauri
        run: |
          cargo build --release

      - name: Run Relaunch Tests
        shell: powershell
        run: |
          $exePath = Resolve-Path "src-tauri\target\release\issuer.exe"
          Write-Host "Built exe: $exePath"

          # Test 1: Ensure relaunch copies to LOCALAPPDATA\Issuer and spawns copy
          Write-Host "=== Test 1: Relaunch - Copy and Restart ==="
          $localDir = "$env:LOCALAPPDATA\Issuer"
          $localExe = Join-Path $localDir (Split-Path $exePath -Leaf)
          if (Test-Path $localExe) { Remove-Item $localExe -Force }

          $process = Start-Process -FilePath $exePath -PassThru -NoNewWindow
          Start-Sleep -Seconds 6

          # original may exit; ensure local copy exists
          if (Test-Path $localExe) {
            Write-Host "PASS: Local copy created at $localExe"
          } else {
            Write-Error "FAIL: Local copy was NOT created at $localExe"
            exit 1
          }

          # Check that a relaunch process is running
          $localProcess = Get-Process -Name "issuer" -ErrorAction SilentlyContinue
          if ($localProcess) {
            Write-Host "PASS: Relaunched process is running (PID: $($localProcess.Id))"
            Stop-Process -Id $localProcess.Id -Force
            Start-Sleep -Seconds 1
          } else {
            Write-Error "FAIL: Relaunched process is not running."; exit 1
          }

          # Test 2: Relaunch prevention via ISSUER_LOCAL_RELAUNCH
          Write-Host "=== Test 2: Relaunch Prevention ==="
          if (Test-Path $localDir) { Remove-Item $localDir -Recurse -Force }
          $env:ISSUER_LOCAL_RELAUNCH = "1"
          $process = Start-Process -FilePath $exePath -PassThru -NoNewWindow
          Start-Sleep -Seconds 4
          if (Test-Path $localExe) { Write-Error "FAIL: Local copy created despite ISSUER_LOCAL_RELAUNCH=1"; Stop-Process -Name issuer -Force -ErrorAction SilentlyContinue; exit 1 } else { Write-Host "PASS: No local copy created (relaunch prevented)." }
          if (-not $process.HasExited) { Stop-Process -Id $process.Id -Force }
          Remove-Item Env:ISSUER_LOCAL_RELAUNCH

          # Test 3: Skip copy when up-to-date (use issuer_version.txt)
          Write-Host "=== Test 3: Skip Copy When Up-to-Date ==="
          if (-not (Test-Path $localDir)) { New-Item -ItemType Directory -Path $localDir | Out-Null }
          Copy-Item $exePath $localExe -Force
          $versionFile = Join-Path $localDir "issuer_version.txt"
          # Set local version to equal to build version to prevent copy
          if ($env:VERSION) { $v = $env:VERSION } else { $v = "$(git describe --tags --abbrev=0 2>$null)" }
          if (-not $v) { $v = "0.0.0" }
          Set-Content -Path $versionFile -Value $v -Encoding UTF8
          $beforeTime = (Get-Item $localExe).LastWriteTime

          Start-Sleep -Seconds 2
          $process = Start-Process -FilePath $exePath -PassThru -NoNewWindow
          Start-Sleep -Seconds 5
          if (-not $process.HasExited) { Stop-Process -Id $process.Id -Force }

          $afterTime = (Get-Item $localExe).LastWriteTime
          if ($beforeTime -eq $afterTime) { Write-Host "PASS: Local copy was NOT overwritten (skip-copy working)." } else { Write-Host "WARNING: Local copy was overwritten." }

          # Cleanup
          if (Test-Path $localDir) { Remove-Item $localDir -Recurse -Force -ErrorAction SilentlyContinue }

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: issuer-windows-release
          path: src-tauri/target/release/issuer.exe
