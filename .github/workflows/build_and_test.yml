name: Windows App Build and Test

# mainブランチにpushされた時、またはPull Requestが作られた時に自動実行
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    # Windows 10(2019) と Windows 11(2022) の両方で同時にテストを走らせます
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-2019, windows-2022]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install flet pyinstaller Pillow flet-desktop pywin32

    - name: Build Executable
      run: python build.py

    # -------------------------------------------------------
    # テスト 1: 強制リランチ（常にローカルコピー＆再起動）
    # -------------------------------------------------------
    - name: "Test 1: Force Relaunch - Copy and Restart"
      run: |
        $exePath = ".\dist\Issuer.exe"
        $localExe = "$env:LOCALAPPDATA\Issuer\Issuer.exe"
        Write-Host "=== Test 1: Force Relaunch ==="

        # 事前にローカルコピーがあれば削除
        if (Test-Path $localExe) { Remove-Item $localExe -Force }

        # ISSUER_FORCE_RELAUNCH=1 で起動 → コピー＆再起動の経路を通す
        $env:ISSUER_FORCE_RELAUNCH = "1"
        $process = Start-Process -FilePath $exePath -PassThru -NoNewWindow
        Start-Sleep -Seconds 8

        # 元のプロセスは exit(0) で終了しているはず
        if (-not $process.HasExited) {
            Write-Host "WARNING: Original process still running, stopping it."
            Stop-Process -Id $process.Id -Force
        }

        # ローカルにコピーされたか確認
        if (Test-Path $localExe) {
            Write-Host "PASS: Local copy created at $localExe"
        } else {
            Write-Error "FAIL: Local copy was NOT created at $localExe"
            exit 1
        }

        # ローカルコピーから起動したプロセスが動いているか確認
        $localProcess = Get-Process -Name "Issuer" -ErrorAction SilentlyContinue
        if ($localProcess) {
            Write-Host "PASS: Relaunched process is running (PID: $($localProcess.Id))"
            Stop-Process -Name "Issuer" -Force
            Start-Sleep -Seconds 2
        } else {
            Write-Error "FAIL: Relaunched process is not running."
            exit 1
        }

        # 環境変数をクリア
        Remove-Item Env:ISSUER_FORCE_RELAUNCH

    # -------------------------------------------------------
    # テスト 2: 再帰防止（ISSUER_LOCAL_RELAUNCH=1 → コピーしない）
    # -------------------------------------------------------
    - name: "Test 2: Relaunch Prevention"
      run: |
        $exePath = ".\dist\Issuer.exe"
        $localExe = "$env:LOCALAPPDATA\Issuer\Issuer.exe"
        Write-Host "=== Test 2: Relaunch Prevention ==="

        # 前のテストで作られたローカルコピーを削除
        if (Test-Path "$env:LOCALAPPDATA\Issuer") {
            Remove-Item "$env:LOCALAPPDATA\Issuer" -Recurse -Force
        }

        # ISSUER_LOCAL_RELAUNCH=1 → リランチせずそのまま起動するはず
        $env:ISSUER_LOCAL_RELAUNCH = "1"
        $process = Start-Process -FilePath $exePath -PassThru -NoNewWindow
        Start-Sleep -Seconds 5

        # コピーが発生していないことを確認
        if (Test-Path $localExe) {
            Write-Error "FAIL: Local copy was created despite ISSUER_LOCAL_RELAUNCH=1"
            Stop-Process -Name "Issuer" -Force -ErrorAction SilentlyContinue
            exit 1
        } else {
            Write-Host "PASS: No local copy created (relaunch prevention working)."
        }

        # プロセスがそのまま動いているか確認
        if (-not $process.HasExited) {
            Write-Host "PASS: App is running directly without relaunch."
            Stop-Process -Id $process.Id -Force
        } else {
            if ($process.ExitCode -ne 0) {
                Write-Error "FAIL: App crashed! (Exit Code: $($process.ExitCode))"
                exit 1
            } else {
                Write-Error "FAIL: App closed immediately."
                exit 1
            }
        }

        Remove-Item Env:ISSUER_LOCAL_RELAUNCH

    # -------------------------------------------------------
    # テスト 3: コピー不要時のスキップ（同一ファイルが既存 → コピーせず再起動）
    # -------------------------------------------------------
    - name: "Test 3: Skip Copy When Up-to-Date"
      run: |
        $exePath = Resolve-Path ".\dist\Issuer.exe"
        $localDir = "$env:LOCALAPPDATA\Issuer"
        $localExe = "$localDir\Issuer.exe"
        Write-Host "=== Test 3: Skip Copy When Up-to-Date ==="

        # 事前にローカルに同一ファイルを配置
        if (-not (Test-Path $localDir)) { New-Item -ItemType Directory -Path $localDir | Out-Null }
        Copy-Item $exePath $localExe -Force
        $beforeTime = (Get-Item $localExe).LastWriteTime

        # 少し待ってからリランチ（タイムスタンプ比較のため）
        Start-Sleep -Seconds 2

        $env:ISSUER_FORCE_RELAUNCH = "1"
        $process = Start-Process -FilePath $exePath -PassThru -NoNewWindow
        Start-Sleep -Seconds 5

        # 元プロセスが終了するのを待つ
        if (-not $process.HasExited) {
            Stop-Process -Id $process.Id -Force
        }

        # コピーが発生していないことを確認（LastWriteTime が変わっていない）
        $afterTime = (Get-Item $localExe).LastWriteTime
        if ($beforeTime -eq $afterTime) {
            Write-Host "PASS: Local copy was NOT overwritten (skip-copy working)."
        } else {
            Write-Host "WARNING: Local copy was overwritten (timestamps differ), but relaunch still works."
        }

        # クリーンアップ
        Stop-Process -Name "Issuer" -Force -ErrorAction SilentlyContinue
        Start-Sleep -Seconds 2
        Remove-Item Env:ISSUER_FORCE_RELAUNCH
        if (Test-Path $localDir) { Remove-Item $localDir -Recurse -Force -ErrorAction SilentlyContinue }